#!/usr/bin/env bash

# ============================================================================
# Hugging Face API 基础示例脚本
# ============================================================================
# 脚本名称：baseline_hf_api.sh
# 用途：从 Hugging Face API 获取模型列表并输出原始 JSON 数据
# 创建日期：2026-01-30
# 作者：Shell翻译注释专家
# ============================================================================

# 设置严格的错误处理模式
# set -e：任何命令返回非零退出状态时立即退出脚本
# set -u：使用未定义的变量时报错并退出
# set -o pipefail：管道中任何命令失败都会导致整个管道失败
set -euo pipefail

# ============================================================================
# 函数：show_help
# ============================================================================
# 功能：显示脚本的帮助信息和使用说明
# 参数：无
# 返回值：无（直接输出帮助文本到标准输出）
# ============================================================================
show_help() {
    # 使用 heredoc 语法输出多行帮助文本
    # EOF 是分隔符，cat 会输出直到遇到 EOF 为止的所有内容
    cat << EOF
超简单的 Hugging Face API 示例（Shell 版本）

使用方法：
  $0 [限制数量]          # 获取指定数量的模型列表（默认为3个）
  $0 --help              # 显示此帮助信息

说明：
  从 Hugging Face API 获取模型列表并输出原始 JSON 格式数据。
  如果设置了环境变量 HF_TOKEN，则使用该令牌进行身份验证。

示例：
  $0                     # 获取默认数量（3个）的模型
  $0 5                   # 获取5个模型
  HF_TOKEN=your_token $0 10  # 使用令牌获取10个模型
EOF
}

# ============================================================================
# 命令行参数处理
# ============================================================================

# 检查第一个参数是否为 --help
# ${1:-}：表示使用第一个参数，如果未设置则使用空字符串
# [[ ]]：bash 的条件测试语法，比 [ ] 更强大
if [[ "${1:-}" == "--help" ]]; then
    show_help
    exit 0  # 成功退出，退出状态码为0
fi

# 设置获取模型的数量限制
# ${1:-3}：使用第一个参数作为限制值，如果未提供则默认为3
LIMIT="${1:-3}"

# 验证 LIMIT 是否为纯数字
# =~：bash 的正则表达式匹配操作符
# ^[0-9]+$：正则表达式，表示从开始到结束都是数字
if ! [[ "$LIMIT" =~ ^[0-9]+$ ]]; then
    # 将错误信息输出到标准错误流（文件描述符2）
    echo "错误：限制数量必须是数字" >&2
    exit 1  # 错误退出，退出状态码为1
fi

# ============================================================================
# HTTP 请求头设置
# ============================================================================

# 初始化 headers 数组
# ()：bash 中定义空数组的语法
headers=()

# 检查是否设置了 HF_TOKEN 环境变量
# -n：测试字符串是否非空
# ${HF_TOKEN:-}：获取 HF_TOKEN 变量，如果未设置则使用空字符串
if [[ -n "${HF_TOKEN:-}" ]]; then
    # 如果设置了令牌，则添加 Authorization 请求头
    # -H：curl 命令的选项，用于添加 HTTP 请求头
    # Bearer：OAuth 2.0 的认证方式
    headers=(-H "Authorization: Bearer ${HF_TOKEN}")
fi

# ============================================================================
# 发送 API 请求
# ============================================================================

# 使用 curl 命令向 Hugging Face API 发送请求
# curl：命令行工具，用于传输数据，支持多种协议
# -s：静默模式，不显示进度条和错误信息
# "${headers[@]}"：数组展开，将 headers 数组的所有元素作为独立参数传递
# 注意：必须使用 "${headers[@]}" 而不是 ${headers[@]} 以正确处理包含空格的元素
curl -s "${headers[@]}" "https://huggingface.co/api/models?limit=${LIMIT}"
